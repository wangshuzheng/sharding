## 联机分析处理 (OLAP)
https://docs.microsoft.com/zh-cn/azure/architecture/data-guide/relational-data/online-analytical-processing

## OLTP
企业用来存储其所有事务和记录的数据库称为联机事务处理 (OLTP) 数据库。
但是，用于 OLTP 的数据库不是为分析而设计的。 因此，从这些数据库中检索答案从时间和工作量角度而言成本高昂。

#### OLTP瓶颈

```
这里影响性能除了绑定变量，还有可能是热快（hot block）。 当一个块被多个用户同时读取时，Oracle 为了维护数据的一致性，需要使用Latch来串行化用户的操作。当一个用户获得了latch后，其他用户就只能等待，获取这个数据块的用户越多，等待就越明显。 这就是热快的问题。 这种热快可能是数据块，也可能是回滚端块。
```

## OLAP
OLAP 系统设计用来以高性能方式从数据中提取此商业智能信息。 这是因为 OLAP 数据库针对高频读取和低频写入进行了优化。

一种应用程序和技术，用于收集、管理处理和显示多维数据以进行分析和管理。OLAP产品能够提供共享多维信息的快速分析。临时分析必须能够在产品本身内部进行，或者在紧密联系的产品中进行。

别名：DSS决策支持系统，数据仓库

##### 考核的标准

往往是磁盘子系统的吞吐量（带宽），如能达到多少MB/s的流量。

###### 吞吐量解决方案

 1. 分区

     1. ```
        分区技术在OLAP系统中的重要性主要体现在数据库管理上，比如数据库加载，可以通过分区交换的方式实现，备份可以通过备份分区表空间实现，删除数据可以通过分区进行删除，至于分区在性能上的影响，它可以使得一些大表的扫描变得很快（只扫描单个分区）。另外，如果分区结合并行的话，也可以使得整个表的扫描会变得很快。总之，分区主要的功能是管理上的方便性，它并不能绝对保证查询性能的提高，有时候分区会带来性能上的提高，有时候会降低。
        ```

 2. 并行

	3. 分开设计与优化

    	1. ```
        对于OLAP系统，在内存上可优化的余地很小，增加CPU 处理速度和磁盘I/O 速度是最直接的提高数据库性能的方法，当然这也意味着系统成本的增加。      
        比如我们要对几亿条或者几十亿条数据进行聚合处理，这种海量的数据，全部放在内存中操作是很难的，同时也没有必要，因为这些数据快很少重用，缓存起来也没有实际意义，而且还会造成物理I/O相当大。 所以这种系统的瓶颈往往是磁盘I/O上面的。
        对于OLAP系统，SQL 的优化非常重要，因为它的数据量很大，做全表扫描和索引对性能上来说差异是非常大的。
        ```

### OLAP

OLAP DataSource： Oracle EssBase

分析系统：Azure Analysis Services



### 语义模型(对用户更友好)
解决用户对SQL、表关系的理解上的问题
同时避免数据库安全、访问控制等问题

### 数据仓库

在下列应用场景中，请考虑使用 OLAP：
1. 你需要快速执行复杂的分析和临时查询，且不能对 OLTP 系统产生负面影响。
2. 你希望为业务用户提供一种简单的方式来基于数据生成报表
3. 你希望提供大量聚合，这些聚合将使用户能够快速获得一致的结果。
OLAP 对于针对大量数据应用聚合计算特别有用。 OLAP 系统针对高频读取应用场景（例如分析和商业智能）进行了优化。 
OLAP 允许用户将多维数据分割为切片，可以采用二维方式（例如透视表）查看切片，或者按特定值来筛选数据。 
此过程有时称为对数据进行“切片和切块”，并且无论是否在多个数据源之间对数据进行了分区，都可以执行此过程。 
这可以帮助用户查明趋势、点模式，以及在不需要知道传统数据分析详细信息的情况下探索数据。
语义模型可以帮助业务用户抽象关系复杂性，并且更轻松地快速分析数据。

### 多维数据模型
多维数据模型是为了满足用户从多角度多层次进行数据查询和分析的需要而建立起来的基于事实和维的数据库模型，其基本的应用是为了实现OLAP（Online Analytical Processing）。

维度上进行`下钻`、`上卷`、`排序`、`过滤`等



### OLAP解决方案

#### impala

`the open source, native analytic database for Apache Hadoop`

#### Hive SQL

#### Google Dremel



- Impala 1.3.0
- Hive-on-Tez: The final phase of the 18-month Stinger initiative (aka Hive 0.13)
- Shark 0.9.2: A port of Hive from UC Berkeley AMPLab that is architecturally similar to Hive-on-Tez, but based on Spark instead of Tez. Shark testing was done on a native in-memory dataset (RDD) as well as HDFS.
- Presto 0.60: Facebook’s query engine project



### 单用户场景

Impala on Parquet运行效率最高，比其后的Shark 0.9.2平均快了5倍。

![img](https://images0.cnblogs.com/blog/123314/201408/310026484546487.png)

### 多用户场景

我们同时测试了单用户和10个用户做对比，测试中Impala更好的体现了其性能优势，比其后的工具快了9.5倍。

![img](https://images0.cnblogs.com/blog/123314/201408/310027010327077.png)

### 吞吐量和硬件使用率

![img](https://images0.cnblogs.com/blog/123314/201408/310027142209080.png)

下面的CPU效率解释了为什么Impala能够做到低延迟和高吞吐量，绝大多数的性能和并发性都在于查询引擎自身的CPU利用效率。

![img](https://images0.cnblogs.com/blog/123314/201408/310028342828522.png)







**多维分析中的常用操作：**

下面介绍数据立方体中最常见的五大操作：切片，切块，旋转，上卷，下钻。

![img](https://pic4.zhimg.com/80/v2-ad261bc2d128ee5ed62146290c9e0763_hd.jpg)

![img](https://pic2.zhimg.com/80/v2-12268959c89202c2c810c2df53a01271_hd.jpg)

# 数据立方体—-维度与OLAP

前面的一篇文章——[数据仓库的多维数据模型](http://webdataanalysis.net/web-data-warehouse/multidimensional-data-model/)中已经简单介绍过多维模型的定义和结构，以及事实表（Fact Table）和维表（Dimension Table）的概念。多维数据模型作为一种新的逻辑模型赋予了数据新的组织和存储形式，而真正体现其在分析上的优势还需要基于模型的有效的操作和处理，也就是OLAP（On-line Analytical Processing，联机分析处理）。

### 数据立方体

关于数据立方体（Data Cube），这里必须注意的是数据立方体只是多维模型的一个形象的说法。立方体其本身只有三维，但多维模型不仅限于三维模型，可以组合更多的维度，但一方面是出于更方便地解释和描述，同时也是给思维成像和想象的空间；另一方面是为了与传统关系型数据库的二维表区别开来，于是就有了数据立方体的叫法。所以本文中也是引用立方体，也就是把多维模型以三维的方式为代表进行展现和描述，其实上Google图片搜索“OLAP”会有一大堆的数据立方体图片，这里我自己画了一个：

![](D:\AnalyicalProcessing\Data-Cube.png)

### OLAP

**OLAP（On-line Analytical Processing，联机分析处理）**是在基于数据仓库多维模型的基础上实现的面向分析的各类操作的集合。可以比较下其与传统的OLTP（On-line Transaction Processing，联机事务处理）的区别来看一下它的特点：

#### OLAP与OLTP

| 数据处理类型 | OLTP                   | OLAP           |
| ------------ | ---------------------- | -------------- |
| 面向对象     | 业务开发人员           | 分析决策人员   |
| 功能实现     | 日常事务处理           | 面向分析决策   |
| 数据模型     | 关系模型               | 多维模型       |
| 数据量       | 几条或几十条记录       | 百万千万条记录 |
| 操作类型     | 查询、插入、更新、删除 | 查询为主       |

#### OLAP的类型

首先要声明的是这里介绍的有关多维数据模型和OLAP的内容基本都是基于ROLAP，因为其他几种类型极少接触，而且相关的资料也不多。

**MOLAP(Multidimensional)**

　　即基于多维数组的存储模型，也是最原始的OLAP，但需要对数据进行预处理才能形成多维结构。

**ROLAP(Relational)**

　　比较常见的OLAP类型，这里介绍和讨论的也基本都是ROLAP类型，可以从多维数据模型的那篇文章的图中看到，其实ROLAP是完全基于关系模型进行存放的，只是它根据分析的需要对模型的结构和组织形式进行的优化，更利于OLAP。

**HOLAP(Hybrid)**

　　介于MOLAP和ROLAP的类型，我的理解是细节的数据以ROLAP的形式存放，更加方便灵活，而高度聚合的数据以MOLAP的形式展现，更适合于高效的分析处理。

另外还有WOLAP(Web-based OLAP)、DOLAP(Desktop OLAP)、RTOLAP(Real-Time OLAP)，具体可以参开维基百科上的解释——[OLAP](http://en.wikipedia.org/wiki/Online_analytical_processing)。

### OLAP的基本操作

我们已经知道OLAP的操作是以查询——也就是数据库的SELECT操作为主，但是查询可以很复杂，比如基于关系数据库的查询可以多表关联，可以使用COUNT、SUM、AVG等聚合函数。OLAP正是基于多维模型定义了一些常见的面向分析的操作类型是这些操作显得更加直观。

OLAP的多维分析操作包括：**钻取（****Drill-down）**、**上卷（****Roll-up）**、**切片（****Slice）**、**切块（****Dice）**以及**旋转（****Pivot）**，下面还是以上面的数据立方体为例来逐一解释下：

![img](https://pic4.zhimg.com/80/v2-ad261bc2d128ee5ed62146290c9e0763_hd.jpg)

**钻取（Drill-down）**：在维的不同层次间的变化，从上层降到下一层，或者说是将汇总数据拆分到更细节的数据，比如通过对2010年第二季度的总销售数据进行钻取来查看2010年第二季度4、5、6每个月的消费数据，如上图；当然也可以钻取浙江省来查看杭州市、宁波市、温州市……这些城市的销售数据。

**上卷（Roll-up）**：钻取的逆操作，即从细粒度数据向高层的聚合，如将江苏省、上海市和浙江省的销售数据进行汇总来查看江浙沪地区的销售数据，如上图。

**切片（Slice）**：选择维中特定的值进行分析，比如只选择电子产品的销售数据，或者2010年第二季度的数据。

**切块（Dice）**：选择维中特定区间的数据或者某批特定值进行分析，比如选择2010年第一季度到2010年第二季度的销售数据，或者是电子产品和日用品的销售数据。

**旋转（Pivot）**：即维的位置的互换，就像是二维表的行列转换，如图中通过旋转实现产品维和地域维的互换。

### OLAP的优势

首先必须说的是，OLAP的优势是基于数据仓库面向主题、集成的、保留历史及不可变更的数据存储，以及多维模型多视角多层次的数据组织形式，如果脱离的这两点，OLAP将不复存在，也就没有优势可言。

#### 数据展现方式

基于多维模型的数据组织让数据的展示更加直观，它就像是我们平常看待各种事物的方式，可以从多个角度多个层面去发现事物的不同特性，而OLAP正是将这种寻常的思维模型应用到了数据分析上。

#### 查询效率

多维模型的建立是基于对OLAP操作的优化基础上的，比如基于各个维的索引、对于一些常用查询所建的视图等，这些优化使得对百万千万甚至上亿数量级的运算变得得心应手。

#### 分析的灵活性

我们知道多维数据模型可以从不同的角度和层面来观察数据，同时可以用上面介绍的各类OLAP操作对数据进行聚合、细分和选取，这样提高了分析的灵活性，可以从不同角度不同层面对数据进行细分和汇总，满足不同分析的需求。

是不是觉得其实OLAP并没有想象中的那么复杂，一旦多维数据模型建成后，在上面做OLAP其实是一件很cool的事情。